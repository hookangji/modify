<?php
session_start(); // ì„¸ì…˜ ì‹œìž‘, ë¡œê·¸ì¸ ìƒíƒœì™€ ì‚¬ìš©ìž ì •ë³´ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•¨

// ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ë¹„í™œì„±í™”í•˜ì—¬ í•­ìƒ ìµœì‹  ë°ì´í„°ë¥¼ í‘œì‹œ
header("Cache-Control: no-cache, must-revalidate"); 
header("Expires: Sat, 1 Jan 2000 00:00:00 GMT");

// JSON íŒŒì¼ ê²½ë¡œ ì„¤ì •
$jsonFile = 'posts.json';

// JSON ë°ì´í„° ì½ê¸° ë° ë°°ì—´ë¡œ ë³€í™˜
$posts = []; // ê²Œì‹œë¬¼ ë°ì´í„°ë¥¼ ì €ìž¥í•  ê¸°ë³¸ ë°°ì—´
if (file_exists($jsonFile)) { // JSON íŒŒì¼ì´ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
    $fileContents = file_get_contents($jsonFile); // íŒŒì¼ ë‚´ìš© ì½ê¸°
    if (!empty($fileContents)) { // íŒŒì¼ ë‚´ìš©ì´ ë¹„ì–´ ìžˆì§€ ì•Šì€ì§€ í™•ì¸
        $posts = json_decode($fileContents, true); // JSON ë°ì´í„°ë¥¼ PHP ë°°ì—´ë¡œ ë³€í™˜
    }
}

// í˜„ìž¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìž ID ê°€ì ¸ì˜¤ê¸°
$currentUser = $_SESSION['userID'] ?? null; // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ìž ID ê°€ì ¸ì˜¤ê¸° (ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš° null)

// ë¡œê·¸ì¸ëœ ì‚¬ìš©ìžì˜ ê²Œì‹œë¬¼ë§Œ í•„í„°ë§
$userPosts = []; // ì‚¬ìš©ìžì˜ ê²Œì‹œë¬¼ì„ ì €ìž¥í•  ë°°ì—´ ì´ˆê¸°í™”
if ($currentUser) { // ì‚¬ìš©ìžê°€ ë¡œê·¸ì¸ëœ ê²½ìš°
    $userPosts = array_filter($posts, function ($post) use ($currentUser) {
        // ê²Œì‹œë¬¼ì˜ userIDê°€ í˜„ìž¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìžì™€ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ë§Œ ë°˜í™˜
        return isset($post['userID']) && $post['userID'] === $currentUser;
    });
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"> <!-- ë¬¸ì„œ ì¸ì½”ë”© ì„¤ì • -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- ë°˜ì‘í˜• ë””ìžì¸ ì§€ì› -->
    <title>Home</title> <!-- íŽ˜ì´ì§€ ì œëª© -->
    <link rel="stylesheet" href="style.css"> <!-- ì™¸ë¶€ CSS íŒŒì¼ ì—°ê²° -->
</head>
<body>
    <!-- í—¤ë” -->
    <header>
        <div class="header-left">
            <!-- Moodify ë¡œê³  í…ìŠ¤íŠ¸ -->
            <a href="main.html" class="logo">Moodify</a> <!-- ë¡œê³ ë¥¼ í´ë¦­í•˜ë©´ ë©”ì¸ íŽ˜ì´ì§€ë¡œ ì´ë™ -->
        </div>
        <div class="header-right">
            <?php if ($currentUser): ?> <!-- ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ -->
                <a href="my-page.php" class="my-page">My page</a> <!-- ë§ˆì´íŽ˜ì´ì§€ë¡œ ì´ë™ -->
                <a href="logout.php">
                    <button>Log out</button> <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
                </a>
            <?php else: ?>
                <a href="login.html">
                    <button>Log in</button> <!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
                </a>
            <?php endif; ?>
        </div>
    </header>

    <!-- ë©”ì¸ ì„¹ì…˜ -->
    <main>
        <section id="posts">
            <?php if ($currentUser): ?> <!-- ë¡œê·¸ì¸ëœ ê²½ìš° -->
                <h2>Your Posts</h2> <!-- ì‚¬ìš©ìž ê²Œì‹œë¬¼ ì„¹ì…˜ ì œëª© -->
                <div class="post-list">
                    <?php if (!empty($userPosts)): ?> <!-- ì‚¬ìš©ìžì˜ ê²Œì‹œë¬¼ì´ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸ -->
                        <?php foreach ($userPosts as $index => $post): ?> <!-- ê²Œì‹œë¬¼ ìˆœíšŒ -->
                            <div class="post-item">
                                <div class="mood-icon">
                                    <?php
                                    // ê°ì • ì•„ì´ì½˜ ë§¤í•‘
                                    $moodIcons = [
                                        'love' => 'ðŸ¥°',
                                        'happy' => 'ðŸ˜Š',
                                        'sad' => 'ðŸ˜¢',
                                        'angry' => 'ðŸ˜¡',
                                        'neutral' => 'ðŸ˜'
                                    ];
                                    // ê²Œì‹œë¬¼ì˜ moodì— í•´ë‹¹í•˜ëŠ” ì•„ì´ì½˜ ì¶œë ¥, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ â“ í‘œì‹œ
                                    echo $moodIcons[$post['mood']] ?? 'â“';
                                    ?>
                                </div>
                                <a href="post-detail.php?id=<?php echo $index; ?>"> <!-- ê²Œì‹œë¬¼ ìƒì„¸ íŽ˜ì´ì§€ ë§í¬ -->
                                    <h3><?php echo htmlspecialchars($post['date'] . ' ' . $post['time']); ?></h3> <!-- ê²Œì‹œë¬¼ ë‚ ì§œì™€ ì‹œê°„ -->
                                    <p><strong>Artist:</strong> <?php echo htmlspecialchars($post['artist']); ?></p> <!-- ì•„í‹°ìŠ¤íŠ¸ ì´ë¦„ -->
                                    <p><strong>Song Title:</strong> <?php echo htmlspecialchars($post['songTitle']); ?></p> <!-- ë…¸ëž˜ ì œëª© -->
                                </a>
                            </div>
                        <?php endforeach; ?>
                    <?php else: ?>
                        <p>You have no posts yet. Write your first memory!</p> <!-- ê²Œì‹œë¬¼ì´ ì—†ì„ ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ -->
                    <?php endif; ?>
                </div>
            <?php else: ?> <!-- ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš° -->
                <h2>Welcome to Moodify!</h2> <!-- í™˜ì˜ ë©”ì‹œì§€ -->
                <p class="welcome-message">Log in to record memories and to see personalized content.</p>
            <?php endif; ?>
        </section>

        <?php if ($currentUser): ?> <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ìžë§Œ ê¸€ì“°ê¸° ë²„íŠ¼ í‘œì‹œ -->
            <a href="write.html">
                <button id="write-post-button">Record</button> <!-- ê¸€ì“°ê¸° ë²„íŠ¼ -->
            </a>
        <?php endif; ?>
    </main>
</body>
</html>